<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add New Painting</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
      }
      .container {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: 30px auto;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
      }
      input[type="text"],
      input[type="number"],
      input[type="url"],
      input[type="file"] {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .message {
        margin-top: 20px;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
      }
      .message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .loading {
        text-align: center;
        margin-top: 10px;
        font-style: italic;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Add New Painting</h1>

      <form id="paintingForm">
        <label for="name">Painting Name:</label>
        <input type="text" id="name" name="name" required /><br />

        <label for="category">Category:</label>
        <input type="text" id="category" name="category" required /><br />

        <label for="medium">Medium:</label>
        <input type="text" id="medium" name="medium" required /><br />

        <label for="size">Size:</label>
        <input type="text" id="size" name="size" required /><br />

        <label for="colour">Colour:</label>
        <input type="text" id="colour" name="colour" /><br />

        <label for="order">Order (Number):</label>
        <input type="number" id="order" name="order" required /><br />

        <label for="imageFile">Image File:</label>
        <input type="file" id="imageFile" accept="image/*" /><br />
        <button type="button" id="uploadImageBtn">Upload Image</button>
        <div id="uploadStatus" class="message"></div>
        <div id="loadingUpload" class="loading" style="display: none">
          Uploading image...
        </div>

        <input type="hidden" id="imageUrl" name="imageUrl" />
        <input type="hidden" id="publicId" name="publicId" />

        <br />
        <button type="submit" id="submitPaintingBtn">Create Painting</button>
        <div id="formMessage" class="message"></div>
        <div id="loadingSubmit" class="loading" style="display: none">
          Submitting painting...
        </div>
      </form>
    </div>

    <script>
      const paintingForm = document.getElementById("paintingForm");
      const imageFile = document.getElementById("imageFile");
      const uploadImageBtn = document.getElementById("uploadImageBtn");
      const submitPaintingBtn = document.getElementById("submitPaintingBtn");
      const imageUrlInput = document.getElementById("imageUrl");
      const publicIdInput = document.getElementById("publicId");
      const uploadStatusDiv = document.getElementById("uploadStatus");
      const formMessageDiv = document.getElementById("formMessage");
      const loadingUploadDiv = document.getElementById("loadingUpload");
      const loadingSubmitDiv = document.getElementById("loadingSubmit");

      let isImageUploaded = false; // Track image upload status

      // --- Image Upload Logic ---
      uploadImageBtn.addEventListener("click", async () => {
        const file = imageFile.files[0];
        if (!file) {
          displayMessage(
            uploadStatusDiv,
            "Please select an image file first.",
            "error"
          );
          return;
        }

        const formData = new FormData();
        formData.append("image", file); // 'image' must match the 'upload.single('image')' in your routes/upload.js

        uploadImageBtn.disabled = true;
        submitPaintingBtn.disabled = true; // Disable main submit button too
        loadingUploadDiv.style.display = "block";
        displayMessage(uploadStatusDiv, "", ""); // Clear previous messages

        try {
          const response = await fetch("http://localhost:3000/upload/image", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (response.ok) {
            imageUrlInput.value = data.imageUrl;
            publicIdInput.value = data.publicId;
            isImageUploaded = true;
            displayMessage(
              uploadStatusDiv,
              "Image uploaded successfully!",
              "success"
            );
          } else {
            displayMessage(
              uploadStatusDiv,
              `Image upload failed: ${data.message || "Unknown error"}`,
              "error"
            );
            isImageUploaded = false;
            imageUrlInput.value = "";
            publicIdInput.value = "";
          }
        } catch (error) {
          console.error("Network or server error during image upload:", error);
          displayMessage(
            uploadStatusDiv,
            "Network error during image upload. Please try again.",
            "error"
          );
          isImageUploaded = false;
          imageUrlInput.value = "";
          publicIdInput.value = "";
        } finally {
          uploadImageBtn.disabled = false;
          submitPaintingBtn.disabled = false; // Re-enable main submit button
          loadingUploadDiv.style.display = "none";
        }
      });

      // --- Painting Form Submission Logic ---
      paintingForm.addEventListener("submit", async (event) => {
        event.preventDefault(); // Prevent default form submission

        if (!isImageUploaded) {
          displayMessage(
            formMessageDiv,
            "Please upload the image first.",
            "error"
          );
          return;
        }
        if (!imageUrlInput.value || !publicIdInput.value) {
          displayMessage(
            formMessageDiv,
            "Image details are missing after upload. Please re-upload image.",
            "error"
          );
          return;
        }

        submitPaintingBtn.disabled = true; // Disable submit button
        loadingSubmitDiv.style.display = "block";
        displayMessage(formMessageDiv, "", ""); // Clear previous messages

        const paintingData = {
          name: document.getElementById("name").value,
          category: document.getElementById("category").value,
          medium: document.getElementById("medium").value,
          size: document.getElementById("size").value,
          colour: document.getElementById("colour").value,
          order: parseInt(document.getElementById("order").value, 10), // Ensure order is a number
          imageUrl: imageUrlInput.value,
          publicId: publicIdInput.value,
        };

        try {
          const response = await fetch("http://localhost:3000/painting", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(paintingData),
          });

          const data = await response.json();

          if (response.ok) {
            displayMessage(
              formMessageDiv,
              "Painting added successfully!",
              "success"
            );
            paintingForm.reset(); // Clear the form
            imageUrlInput.value = ""; // Clear hidden fields
            publicIdInput.value = "";
            isImageUploaded = false; // Reset image upload status
            displayMessage(uploadStatusDiv, "", ""); // Clear image upload message
          } else {
            // Display specific validation errors if available
            if (data.errors) {
              let errorMessage = "Validation failed:<br>";
              for (const field in data.errors) {
                errorMessage += `- ${data.errors[field]}<br>`;
              }
              displayMessage(formMessageDiv, errorMessage, "error");
            } else {
              displayMessage(
                formMessageDiv,
                `Failed to add painting: ${data.message || "Unknown error"}`,
                "error"
              );
            }
          }
        } catch (error) {
          console.error(
            "Network or server error during painting submission:",
            error
          );
          displayMessage(
            formMessageDiv,
            "Network error. Please check server and try again.",
            "error"
          );
        } finally {
          submitPaintingBtn.disabled = false; // Re-enable submit button
          loadingSubmitDiv.style.display = "none";
        }
      });

      // Helper function to display messages
      function displayMessage(element, message, type) {
        element.innerHTML = message;
        element.className = `message ${type}`;
      }
    </script>
  </body>
</html>
