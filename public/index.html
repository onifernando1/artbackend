<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add New Painting</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 30px auto;
        padding: 30px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #007bff;
        margin-bottom: 30px;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .top-bar .welcome-message {
        font-size: 1.1em;
        color: #555;
        font-weight: bold;
      }
      .top-bar .auth-controls {
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .auth-controls .logout-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.2s;
      }
      .auth-controls .logout-btn:hover {
        background-color: #c82333;
      }
      .auth-controls .gallery-link {
        text-decoration: none;
        color: #007bff;
        font-size: 1.1em;
        transition: color 0.2s;
      }
      .auth-controls .gallery-link:hover {
        text-decoration: underline;
        color: #0056b3;
      }

      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
      }
      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group input[type="url"],
      .form-group select,
      .form-group input[type="file"] {
        /* Added file input styling */
        width: calc(100% - 22px);
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 1em;
        box-sizing: border-box;
      }
      .form-group input[type="text"]:focus,
      .form-group input[type="number"]:focus,
      .form-group input[type="url"]:focus,
      .form-group select:focus,
      .form-group input[type="file"]:focus {
        /* Added file input styling */
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }
      .btn {
        background-color: #28a745;
        color: white;
        padding: 14px 25px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.3s ease;
        width: 100%;
        margin-top: 15px;
      }
      .btn:hover {
        background-color: #218838;
      }
      .message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-size: 1.1em;
        font-weight: bold;
        display: none; /* Hidden by default */
      }
      .message.loading {
        background-color: #e0f7fa;
        color: #00796b;
      }
      .message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-bar">
        <h1 style="margin: 0">Add New Painting</h1>
        <div class="auth-controls">
          <span class="welcome-message" id="welcomeMessage"></span>
          <a href="gallery.html" class="gallery-link">‚Üê View Gallery</a>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <form id="addPaintingForm">
        <div class="form-group">
          <label for="name">Painting Name:</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div class="form-group">
          <label for="category">Category:</label>
          <input type="text" id="category" name="category" required />
        </div>
        <div class="form-group">
          <label for="medium">Medium:</label>
          <input type="text" id="medium" name="medium" required />
        </div>
        <div class="form-group">
          <label for="size">Size:</label>
          <input type="text" id="size" name="size" required />
        </div>
        <div class="form-group">
          <label for="colour">Colour (Optional):</label>
          <input type="text" id="colour" name="colour" />
        </div>
        <div class="form-group">
          <label for="order">Order (Number):</label>
          <input type="number" id="order" name="order" required />
        </div>
        <div class="form-group">
          <label for="imageFile">Upload Image:</label>
          <input
            type="file"
            id="imageFile"
            name="imageFile"
            accept="image/*"
            required
          />
        </div>
        <button type="submit" class="btn">Add Painting</button>
      </form>
      <div id="message" class="message"></div>
    </div>

    <script>
      const addPaintingForm = document.getElementById("addPaintingForm");
      const messageDiv = document.getElementById("message");
      const logoutBtn = document.getElementById("logoutBtn");
      const welcomeMessage = document.getElementById("welcomeMessage");
      const imageFileInput = document.getElementById("imageFile"); // Get the file input

      // --- Authentication Check ---
      const token = localStorage.getItem("jwtToken");
      const username = localStorage.getItem("username");

      if (!token) {
        // No token found, redirect to login page
        window.location.href = "login.html";
      } else {
        if (username) {
          welcomeMessage.textContent = `Welcome, ${username}!`;
        }
      }

      // --- Logout Functionality ---
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("jwtToken"); // Remove token
        localStorage.removeItem("username"); // Remove username
        window.location.href = "login.html"; // Redirect to login
      });

      // Helper function to display messages
      function displayMessage(msg, type, duration = 3000) {
        messageDiv.textContent = msg;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";
        if (duration) {
          setTimeout(() => {
            messageDiv.style.display = "none";
            messageDiv.textContent = "";
          }, duration);
        }
      }

      // --- Fetch Utilities with Authorization Header ---
      async function authorizedFetch(url, options = {}) {
        const headers = {
          ...options.headers,
          Authorization: `Bearer ${token}`, // Add JWT to Authorization header
        };

        const response = await fetch(url, { ...options, headers });

        // If token is invalid or expired, backend returns 401. Redirect to login.
        if (response.status === 401 || response.status === 403) {
          displayMessage(
            "Session expired or not authorized. Please log in again.",
            "error",
            0
          );
          localStorage.removeItem("jwtToken");
          localStorage.removeItem("username");
          setTimeout(() => {
            window.location.href = "login.html";
          }, 1500);
          throw new Error("Unauthorized"); // Throw to stop further processing
        }
        return response;
      }

      addPaintingForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const imageFile = imageFileInput.files[0]; // Get the selected file

        if (!imageFile) {
          displayMessage("Please select an image file.", "error");
          return;
        }

        displayMessage("Uploading image and adding painting...", "loading", 0); // Display loading message indefinitely

        try {
          // 1. Prepare data for backend (including the file)
          // Use FormData to send file and other text data
          const formData = new FormData();
          formData.append("name", addPaintingForm.name.value);
          formData.append("category", addPaintingForm.category.value);
          formData.append("medium", addPaintingForm.medium.value);
          formData.append("size", addPaintingForm.size.value);
          formData.append("colour", addPaintingForm.colour.value);
          formData.append("order", parseInt(addPaintingForm.order.value));
          formData.append("image", imageFile); // Append the actual file

          // 2. Send the FormData to your backend
          // The backend will then handle the Cloudinary upload
          const response = await authorizedFetch(
            "http://localhost:3000/painting", // Your backend endpoint
            {
              method: "POST",
              // No 'Content-Type' header needed for FormData; browser sets it automatically
              body: formData,
            }
          );

          const data = await response.json();

          if (response.ok) {
            displayMessage("Painting added successfully!", "success");
            addPaintingForm.reset(); // Clear the form after successful submission
          } else {
            displayMessage(data.message || "Failed to add painting.", "error");
          }
        } catch (error) {
          if (error.message !== "Unauthorized") {
            console.error("Error adding painting:", error);
            displayMessage(
              "Network error or backend issue. Could not add painting.",
              "error"
            );
          }
        }
      });
    </script>
  </body>
</html>
